<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🚀 ICARUS COMPLETE - Advanced Crafting Calculator</title>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.4/babel.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 30%, #16213e 100%);
            color: #ffffff;
            line-height: 1.6;
            min-height: 100vh;
        }

        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .app-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 30px;
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .app-title {
            font-size: 3rem;
            font-weight: 900;
            background: linear-gradient(135deg, #00d4ff 0%, #ff6b6b 50%, #4ecdc4 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .app-subtitle {
            font-size: 1.2rem;
            color: #b0b3b8;
            font-weight: 500;
        }

        .stats-header {
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .loading-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 50vh;
            gap: 20px;
        }

        .loading-spinner {
            border: 4px solid rgba(255,255,255,0.1);
            border-left: 4px solid #00d4ff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: #00d4ff;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .loading-details {
            color: #b0b3b8;
            font-size: 0.9rem;
        }

        .error-screen {
            background: rgba(255, 107, 107, 0.1);
            border: 1px solid rgba(255, 107, 107, 0.3);
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            color: #ff6b6b;
        }

        .error-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 15px;
        }

        .error-message {
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .retry-button {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .retry-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3);
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 30px;
            align-items: start;
        }

        .content-panel {
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            padding: 25px;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255,255,255,0.1);
            min-height: 600px;
        }

        .tab-nav {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            background: rgba(0,0,0,0.3);
            padding: 5px;
            border-radius: 15px;
        }

        .tab-button {
            flex: 1;
            padding: 12px 20px;
            background: transparent;
            border: none;
            color: #b0b3b8;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .tab-button.active {
            background: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 212, 255, 0.3);
        }

        .tab-button:hover:not(.active) {
            background: rgba(255,255,255,0.1);
            color: white;
        }

        .search-controls {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .search-input, .filter-select {
            padding: 12px 16px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 10px;
            color: white;
            font-size: 14px;
            outline: none;
        }

        .search-input::placeholder {
            color: #b0b3b8;
        }

        .filter-select option {
            background: #1a1a2e;
            color: white;
        }

        .items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 12px;
            max-height: 500px;
            overflow-y: auto;
            padding: 10px;
            padding-right: 15px;
        }

        .items-grid::-webkit-scrollbar {
            width: 8px;
        }

        .items-grid::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
        }

        .items-grid::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.3);
            border-radius: 4px;
        }

        .item-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0.04) 100%);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            min-height: 180px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .item-card:hover {
            background: linear-gradient(135deg, rgba(255,255,255,0.15) 0%, rgba(255,255,255,0.08) 100%);
            border-color: rgba(0, 212, 255, 0.5);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 212, 255, 0.15);
        }

        .item-card.selected {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.3) 0%, rgba(0, 212, 255, 0.15) 100%);
            border-color: #00d4ff;
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.4);
        }

        .item-card.unavailable {
            opacity: 0.6;
            background: linear-gradient(135deg, rgba(255, 107, 107, 0.2) 0%, rgba(255, 107, 107, 0.1) 100%);
            border-color: rgba(255, 107, 107, 0.4);
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .item-name {
            font-weight: 700;
            font-size: 13px;
            color: #ffffff;
            flex: 1;
            line-height: 1.3;
            margin-bottom: 4px;
        }

        .item-category {
            font-size: 11px;
            color: #b0b3b8;
            margin-bottom: 8px;
            text-transform: capitalize;
        }

        .availability-indicator {
            font-size: 16px;
            margin-left: 8px;
            flex-shrink: 0;
        }

        .item-details {
            display: flex;
            gap: 8px;
            align-items: center;
            font-size: 11px;
            margin-top: auto;
        }

        .tier-badge {
            background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%);
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 10px;
        }

        .crafted-location {
            color: #b0b3b8;
            font-size: 10px;
            flex: 1;
            text-align: right;
        }

        .shopping-cart {
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            padding: 25px;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255,255,255,0.1);
            max-height: 700px;
            overflow-y: auto;
        }

        .cart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .cart-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: #ffffff;
        }

        .cart-count {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 14px;
        }

        .cart-items {
            min-height: 200px;
        }

        .cart-empty {
            text-align: center;
            color: #666;
            padding: 40px 20px;
            font-style: italic;
        }

        .cart-item {
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .cart-item:hover {
            background: rgba(255,255,255,0.12);
        }

        .cart-item-info {
            flex: 1;
        }

        .cart-item-name {
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 2px;
            font-size: 13px;
        }

        .cart-item-details {
            font-size: 11px;
            color: #b0b3b8;
            text-transform: capitalize;
        }

        .cart-item-quantity {
            background: rgba(0, 212, 255, 0.2);
            color: #00d4ff;
            padding: 4px 8px;
            border-radius: 6px;
            font-weight: 700;
            font-size: 12px;
            margin: 0 10px;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            flex: 1;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn.primary {
            background: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%);
            color: white;
        }

        .btn.secondary {
            background: rgba(255,255,255,0.1);
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .btn.remove {
            background: rgba(255, 107, 107, 0.2);
            color: #ff6b6b;
            min-width: auto;
            padding: 4px 8px;
            font-size: 12px;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .results-panel {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
        }

        .results-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: #00d4ff;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .resource-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .resource-item:last-child {
            border-bottom: none;
        }

        .resource-name {
            color: #ffffff;
            font-weight: 500;
            font-size: 13px;
        }

        .resource-amount {
            background: rgba(255, 107, 107, 0.2);
            color: #ff6b6b;
            padding: 4px 8px;
            border-radius: 6px;
            font-weight: 700;
            font-size: 12px;
        }

        .success-banner {
            background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            font-weight: 600;
            text-align: center;
        }

        .map-info {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
        }

        .map-info h3 {
            color: #00d4ff;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .map-info p {
            color: #b0b3b8;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .resource-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
            margin-top: 15px;
        }

        .resource-badge {
            background: rgba(255,255,255,0.1);
            padding: 6px 10px;
            border-radius: 8px;
            text-align: center;
            font-size: 11px;
            color: #ffffff;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .stats-panel {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            font-size: 12px;
            color: #b0b3b8;
        }

        .stats-panel div {
            margin-bottom: 5px;
        }

        .stats-panel div:last-child {
            margin-bottom: 0;
        }

        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
            padding: 8px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
        }

        .quantity-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 6px;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.2s ease;
        }

        .quantity-btn.increase {
            background: #4ecdc4;
        }

        .quantity-btn:hover {
            transform: scale(1.1);
        }

        .quantity-display {
            min-width: 20px;
            text-align: center;
            font-size: 14px;
            font-weight: bold;
            color: #00d4ff;
        }

        .add-btn {
            background: #00d4ff;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 11px;
            font-weight: bold;
            margin-left: 4px;
            transition: all 0.2s ease;
        }

        .add-btn:disabled {
            background: #666;
            cursor: not-allowed;
        }

        .add-btn:hover:not(:disabled) {
            transform: scale(1.05);
        }

        .map-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .map-label {
            color: #b0b3b8;
            font-weight: 600;
            margin-right: 10px;
        }

        .map-btn {
            padding: 10px 16px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 12px;
            font-weight: 600;
        }

        .map-btn.active {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            border-color: #ff6b6b;
            transform: translateY(-1px);
        }

        .map-btn:hover:not(.active) {
            background: rgba(255,255,255,0.2);
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .search-controls {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .action-buttons {
                flex-direction: column;
            }

            .items-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div id="root">
        <div class="loading-screen">
            <div class="loading-spinner"></div>
            <div class="loading-text">Loading ICARUS Complete...</div>
            <div class="loading-details">Fetching recipe database...</div>
        </div>
    </div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Updated category files for new structure
        const CATEGORY_FILES = [
            'weapons_melee', 'weapons_ranged', 'ammunition', 'armor_clothing',
            'tools', 'building_structures', 'building_furniture',
            'consumables_food', 'consumables_medicine',
            'resources_raw', 'resources_processed', 'deployables',
            'orbital_items', 'misc'
        ];

        const MAP_RESOURCES = {
            "Olympus": ["Stone", "Wood", "Stick", "Sticks", "Fiber", "Leather", "Fur", "Bone", "Clay", "Ice", "Water", "Coal", "Oxite", "Sulfur", "Silica", "Tree Sap", "Carbon Paste", "Salt", "Iron Ore", "Copper Ore", "Gold Ore", "Aluminum Ore", "Aluminium Ore", "Platinum Ore", "Titanium Ore", "Exotics", "Exotic Matter", "Frozen Ore"],
            "Styx": ["Stone", "Wood", "Stick", "Sticks", "Fiber", "Leather", "Fur", "Bone", "Clay", "Ice", "Water", "Coal", "Oxite", "Sulfur", "Silica", "Tree Sap", "Carbon Paste", "Salt", "Iron Ore", "Copper Ore", "Gold Ore", "Aluminum Ore", "Aluminium Ore", "Platinum Ore", "Titanium Ore", "Frozen Ore", "Exotics", "Exotic Matter", "Caveworm Chitin"],
            "Prometheus": ["Stone", "Wood", "Stick", "Sticks", "Fiber", "Leather", "Fur", "Bone", "Clay", "Ice", "Water", "Coal", "Oxite", "Sulfur", "Silica", "Tree Sap", "Carbon Paste", "Salt", "Iron Ore", "Copper Ore", "Gold Ore", "Aluminum Ore", "Aluminium Ore", "Platinum Ore", "Titanium Ore", "Exotics", "Exotic Matter", "Obsidian", "Shaped Obsidian", "Caveworm Chitin"]
        };

        function ItemCard({ item, recipe, isSelected, isAvailable, onClick, onQuantityChange, currentQuantity }) {
            const getTierColor = (tier) => {
                switch(tier) {
                    case 0: return "#888";
                    case 1: return "#4ecdc4";
                    case 2: return "#45b7d1";
                    case 3: return "#f39c12";
                    case 4: return "#e74c3c";
                    default: return "#4ecdc4";
                }
            };

            const getIcon = (category) => {
                const cat = (category || '').toLowerCase();
                if (cat.includes("tool")) return "🔧";
                if (cat.includes("weapon")) return "⚔️";
                if (cat.includes("armor")) return "🛡️";
                if (cat.includes("deployable")) return "🏭";
                if (cat.includes("building")) return "🏗️";
                if (cat.includes("furniture")) return "🪑";
                if (cat.includes("consumable") || cat.includes("food") || cat.includes("medicine")) return "🧪";
                if (cat.includes("resource")) return "🔩";
                if (cat.includes("ammunition")) return "🏹";
                if (cat.includes("orbital")) return "🛸";
                return "📋";
            };

            return React.createElement('div', {
                className: `item-card ${isSelected ? 'selected' : ''} ${!isAvailable ? 'unavailable' : ''}`
            }, [
                React.createElement('div', { className: 'item-header', key: 'header' }, [
                    React.createElement('div', { key: 'info' }, [
                        React.createElement('div', { className: 'item-name', key: 'name' }, 
                            `${getIcon(item.category)} ${item.name}`
                        ),
                        React.createElement('div', { className: 'item-category', key: 'category' }, 
                            item.category || 'unknown'
                        )
                    ]),
                    React.createElement('div', { className: 'availability-indicator', key: 'availability' }, 
                        isAvailable ? "✅" : "❌"
                    )
                ]),
                React.createElement('div', { className: 'item-details', key: 'details' }, [
                    React.createElement('span', { 
                        className: 'tier-badge', 
                        key: 'tier',
                        style: { background: getTierColor(item.tier || 0) }
                    }, `T${item.tier || 0}`),
                    React.createElement('span', { className: 'crafted-location', key: 'crafted_at' }, 
                        item.crafted_at || 'unknown'
                    )
                ]),
                React.createElement('div', { className: 'quantity-controls', key: 'quantity-controls' }, [
                    React.createElement('button', {
                        key: 'decrease',
                        className: 'quantity-btn',
                        onClick: (e) => {
                            e.stopPropagation();
                            if (currentQuantity > 0) {
                                onQuantityChange(item.name, currentQuantity - 1);
                            }
                        }
                    }, '-'),
                    React.createElement('span', {
                        key: 'quantity-display',
                        className: 'quantity-display'
                    }, currentQuantity || 0),
                    React.createElement('button', {
                        key: 'increase',
                        className: 'quantity-btn increase',
                        onClick: (e) => {
                            e.stopPropagation();
                            onQuantityChange(item.name, (currentQuantity || 0) + 1);
                        }
                    }, '+'),
                    React.createElement('button', {
                        key: 'add-to-cart',
                        className: 'add-btn',
                        onClick: (e) => {
                            e.stopPropagation();
                            if (currentQuantity > 0) {
                                onClick(item);
                            }
                        },
                        disabled: !currentQuantity || currentQuantity === 0
                    }, 'Add')
                ])
            ]);
        }

        function CartItem({ item, details, onRemove }) {
            const crafted_at = item.crafted_at || "Unknown";
            const tier = item.tier || 0;
            
            return React.createElement('div', { className: 'cart-item' }, [
                React.createElement('div', { className: 'cart-item-info', key: 'info' }, [
                    React.createElement('div', { className: 'cart-item-name', key: 'name' }, item.name),
                    React.createElement('div', { className: 'cart-item-details', key: 'details' }, 
                        `${crafted_at} • T${tier}`
                    )
                ]),
                React.createElement('div', { className: 'cart-item-quantity', key: 'quantity' }, `${details.quantity}x`),
                React.createElement('button', {
                    key: 'remove',
                    className: 'btn remove',
                    onClick: () => onRemove(item.name)
                }, "✕")
            ]);
        }

        function CraftingCalculator() {
            const [allItems, setAllItems] = useState([]);
            const [loading, setLoading] = useState(true);
            const [loadingText, setLoadingText] = useState('Fetching recipe database...');
            const [error, setError] = useState(null);
            const [activeTab, setActiveTab] = useState('calculator');
            const [currentMap, setCurrentMap] = useState('Olympus');
            const [searchTerm, setSearchTerm] = useState('');
            const [categoryFilter, setCategoryFilter] = useState('All');
            const [tierFilter, setTierFilter] = useState('All');
            const [shoppingCart, setShoppingCart] = useState({});
            const [results, setResults] = useState(null);
            const [itemQuantities, setItemQuantities] = useState({});

            useEffect(() => {
                loadRecipes();
            }, []);

            const loadRecipes = async () => {
                try {
                    setLoading(true);
                    setError(null);
                    setLoadingText('Fetching recipe database...');

                    const successfulPath = './icarus_data/'; // adjust if needed

                    // Load manifest
                    setLoadingText('Loading manifest...');
                    const manifestRes = await fetch(`${successfulPath}manifest.json`);
                    if (!manifestRes.ok) throw new Error(`Failed to load manifest.json: ${manifestRes.status}`);
                    let files = await manifestRes.json();

                    // skip big/combined files if present
                    files = files.filter(f => f && !f.startsWith('_') && f !== 'all_items.json');

                    setLoadingText('Loading all items...');
                    const allItemsRaw = [];

                    // Fetch all JSON files in parallel
                    await Promise.all(files.map(async (file) => {
                        try {
                            const res = await fetch(`${successfulPath}${file}`);
                            if (!res.ok) {
                                console.warn(`Skipped ${file}: ${res.status}`);
                                return;
                            }
                            const data = await res.json();

                            // Accept { items: [...] }, plain array, or single object
                            if (Array.isArray(data.items)) {
                                data.items.forEach(i => allItemsRaw.push({ ...i, __sourceFile: file }));
                            } else if (Array.isArray(data)) {
                                data.forEach(i => allItemsRaw.push({ ...i, __sourceFile: file }));
                            } else if (data && typeof data === 'object') {
                                allItemsRaw.push({ ...data, __sourceFile: file });
                            } else {
                                console.warn(`${file} has unexpected format`, data);
                            }
                        } catch (err) {
                            console.warn(`Could not load ${file}:`, err.message);
                        }
                    }));

                    // Helpers
                    const normalizeCrafted = raw => {
                        const r = raw ?? '';
                        const s = (typeof r === 'string') ? r.trim() : r;
                        return (s && s.toLowerCase() !== 'unknown') ? s : undefined;
                    };

                    const normalizeIngredients = raw => {
                        if (!raw) return undefined;
                        if (typeof raw === 'object' && !Array.isArray(raw)) return raw;

                        if (Array.isArray(raw)) {
                            const obj = {};
                            raw.forEach(entry => {
                                if (!entry) return;
                                if (typeof entry === 'string') obj[entry] = (obj[entry] || 0) + 1;
                                else if (entry.name && entry.qty != null) obj[entry.name] = (obj[entry.name] || 0) + Number(entry.qty);
                                else if (entry[0] && entry[1]) obj[String(entry[0])] = (obj[String(entry[0])] || 0) + Number(entry[1]);
                            });
                            return Object.keys(obj).length ? obj : undefined;
                        }

                        return undefined;
                    };

                    // Deduplicate & merge intelligently by name or url
                    const itemMap = new Map();

                    allItemsRaw.forEach(item => {
                        const key = (item.name && String(item.name).trim()) || (item.url && String(item.url).trim());
                        if (!key) return;

                        const sourceFile = item.__sourceFile;
                        const candidate = { ...item };

                        candidate.crafted_at = normalizeCrafted(candidate.crafted_at ?? candidate.craftedAt);
                        candidate.ingredients = normalizeIngredients(candidate.ingredients ?? candidate.recipe ?? candidate.components);

                        if (itemMap.has(key)) {
                            const existing = itemMap.get(key);

                            // Prefer a real crafted_at
                            if ((!existing.crafted_at || existing.crafted_at === undefined) && candidate.crafted_at) {
                                existing.crafted_at = candidate.crafted_at;
                                existing.__craftedFrom = sourceFile;
                            }

                            // Merge ingredients
                            if (candidate.ingredients) {
                                existing.ingredients = existing.ingredients || {};
                                Object.entries(candidate.ingredients).forEach(([name, qty]) => {
                                    existing.ingredients[name] = qty; // overwrite/add
                                });
                            }

                            // Merge other fields if missing
                            if (!existing.category && candidate.category) existing.category = candidate.category;
                            if ((!existing.tier || existing.tier === 0) && candidate.tier) existing.tier = candidate.tier;

                        } else {
                            if (candidate.crafted_at) candidate.__craftedFrom = sourceFile;
                            itemMap.set(key, candidate);
                        }
                    });

                    // Final normalization for UI fallback
                    const uniqueItems = Array.from(itemMap.values());
                    uniqueItems.forEach(it => {
                        if (!it.crafted_at) it.crafted_at = undefined;
                        if (!it.ingredients) it.ingredients = undefined;
                    });

                    console.log(`✅ Loaded ${uniqueItems.length} unique items (merged from ${allItemsRaw.length} raw entries).`);
                    console.log('Sample items with crafted source:', uniqueItems
                        .filter(i => i.__craftedFrom)
                        .slice(0, 10)
                        .map(i => ({ name: i.name, crafted_at: i.crafted_at, from: i.__craftedFrom })));

                    setAllItems(uniqueItems);
                    setLoading(false);
                    setLoadingText('');
                } catch (err) {
                    console.error('Error loading recipes:', err);
                    setError({
                        title: 'Failed to Load Recipe Database',
                        message: err.message
                    });
                    setLoading(false);
                    setLoadingText('');
                }
            };






            const categories = [...new Set(allItems.map(item => item.category).filter(Boolean))].sort();
            const tiers = [...new Set(allItems.map(item => item.tier).filter(t => t !== undefined))].sort();

            const handleQuantityChange = (itemName, quantity) => {
                setItemQuantities(prev => ({
                    ...prev,
                    [itemName]: Math.max(0, quantity)
                }));
            };

            const checkItemAvailability = (item, map) => {
                // Check for Prometheus-exclusive items (Obsidian-based)
                const ingredients = item.ingredients || {};
                const hasObsidian = Object.keys(ingredients).some(mat => 
                    mat.toLowerCase().includes('obsidian')
                );
                
                if (hasObsidian && map !== 'Prometheus') {
                    return false;
                }
                
                // Everything else is available
                return true;
            };

            const filteredItems = allItems.filter(item => {
                const matchesSearch = item.name.toLowerCase().includes(searchTerm.toLowerCase());
                const matchesCategory = categoryFilter === 'All' || item.category === categoryFilter;
                const matchesTier = tierFilter === 'All' || (item.tier || 0).toString() === tierFilter;
                return matchesSearch && matchesCategory && matchesTier;
            });

            const itemsWithAvailability = filteredItems.map(item => ({
                item,
                recipe: item,
                isAvailable: checkItemAvailability(item, currentMap)
            }));

            const addToCart = (item) => {
                const quantity = itemQuantities[item.name] || 1;
                setShoppingCart(prev => ({
                    ...prev,
                    [item.name]: {
                        quantity: (prev[item.name]?.quantity || 0) + quantity,
                        item: item
                    }
                }));
                
                setItemQuantities(prev => ({
                    ...prev,
                    [item.name]: 0
                }));
                
                setResults({ type: 'success', message: `${quantity}x ${item.name} added to cart!` });
                setTimeout(() => setResults(null), 2000);
            };

            const removeFromCart = (itemName) => {
                setShoppingCart(prev => {
                    const newCart = { ...prev };
                    delete newCart[itemName];
                    return newCart;
                });
            };

            const clearCart = () => {
                setShoppingCart({});
                setItemQuantities({});
                setResults({ type: 'success', message: 'Cart cleared!' });
                setTimeout(() => setResults(null), 2000);
            };

            const calculateRequirements = () => {
                if (Object.keys(shoppingCart).length === 0) {
                    setResults({ type: 'error', message: 'Cart is empty!' });
                    setTimeout(() => setResults(null), 3000);
                    return;
                }

                const rawMaterials = {};
                
                const processItem = (item, quantity) => {
                    const ingredients = item.ingredients || {};
                    
                    if (Object.keys(ingredients).length === 0) {
                        // Raw material
                        rawMaterials[item.name] = (rawMaterials[item.name] || 0) + quantity;
                        return;
                    }
                    
                    // Process ingredients
                    Object.entries(ingredients).forEach(([materialName, amount]) => {
                        // Find the material in allItems
                        const materialItem = allItems.find(i => i.name === materialName);
                        if (materialItem) {
                            processItem(materialItem, amount * quantity);
                        } else {
                            // Material not in database, treat as raw
                            rawMaterials[materialName] = (rawMaterials[materialName] || 0) + (amount * quantity);
                        }
                    });
                };

                Object.entries(shoppingCart).forEach(([itemName, details]) => {
                    processItem(details.item, details.quantity);
                });

                setResults({
                    type: 'materials',
                    rawMaterials
                });
            };

            const renderResults = () => {
                if (!results) return null;
                
                if (results.type === 'success') {
                    return React.createElement('div', { className: 'success-banner' }, `✅ ${results.message}`);
                }
                
                if (results.type === 'error') {
                    return React.createElement('div', { 
                        style: { 
                            background: 'rgba(255, 107, 107, 0.2)', 
                            color: '#ff6b6b', 
                            padding: '15px', 
                            borderRadius: '10px', 
                            marginTop: '15px',
                            textAlign: 'center',
                            fontWeight: '600'
                        } 
                    }, `❌ ${results.message}`);
                }
                
                if (results.type === 'materials') {
                    const unavailableRawMaterials = Object.keys(results.rawMaterials).filter(material => 
                        material.toLowerCase().includes('obsidian') && currentMap !== 'Prometheus'
                    );

                    return React.createElement('div', { className: 'results-panel' }, [
                        React.createElement('div', { className: 'results-title', key: 'title' }, '⛏️ Total Raw Materials Summary'),
                        ...Object.entries(results.rawMaterials).map(([material, amount]) => {
                            const isAvailable = !(material.toLowerCase().includes('obsidian') && currentMap !== 'Prometheus');
                            
                            return React.createElement('div', { key: material, className: 'resource-item' }, [
                                React.createElement('span', { className: 'resource-name', key: 'name' }, 
                                    `${isAvailable ? '✅' : '❌'} ${material}`
                                ),
                                React.createElement('span', { className: 'resource-amount', key: 'amount' }, 
                                    `${amount}x`
                                )
                            ]);
                        }),
                        unavailableRawMaterials.length > 0 && React.createElement('div', {
                            key: 'warning',
                            style: {
                                marginTop: '15px',
                                padding: '10px',
                                background: 'rgba(255, 107, 107, 0.1)',
                                border: '1px solid rgba(255, 107, 107, 0.3)',
                                borderRadius: '8px',
                                fontSize: '12px',
                                color: '#ff6b6b'
                            }
                        }, `⚠️ ${unavailableRawMaterials.length} materials not available on ${currentMap}`)
                    ]);
                }
                
                return null;
            };

            if (loading) {
                return React.createElement('div', { className: 'app-container' }, [
                    React.createElement('div', { className: 'app-header', key: 'header' }, [
                        React.createElement('h1', { className: 'app-title', key: 'title' }, "🚀 ICARUS COMPLETE"),
                        React.createElement('p', { className: 'app-subtitle', key: 'subtitle' }, "Advanced Crafting Calculator")
                    ]),
                    React.createElement('div', { className: 'loading-screen', key: 'loading' }, [
                        React.createElement('div', { className: 'loading-spinner', key: 'spinner' }),
                        React.createElement('div', { className: 'loading-text', key: 'text' }, '🚀 Loading ICARUS Complete...'),
                        React.createElement('div', { className: 'loading-details', key: 'details' }, loadingText)
                    ])
                ]);
            }

            if (error) {
                return React.createElement('div', { className: 'app-container' }, [
                    React.createElement('div', { className: 'app-header', key: 'header' }, [
                        React.createElement('h1', { className: 'app-title', key: 'title' }, "🚀 ICARUS COMPLETE"),
                        React.createElement('p', { className: 'app-subtitle', key: 'subtitle' }, "Advanced Crafting Calculator")
                    ]),
                    React.createElement('div', { className: 'error-screen', key: 'error' }, [
                        React.createElement('div', { className: 'error-title', key: 'title' }, `❌ ${error.title}`),
                        React.createElement('div', { className: 'error-message', key: 'message' }, error.message),
                        React.createElement('button', {
                            key: 'retry',
                            className: 'retry-button',
                            onClick: loadRecipes
                        }, 'Retry Loading')
                    ])
                ]);
            }

            const renderTabContent = () => {
                if (activeTab === 'calculator') {
                    const availableCount = itemsWithAvailability.filter(({isAvailable}) => isAvailable).length;
                    const totalCount = itemsWithAvailability.length;

                    return React.createElement('div', { key: 'calculator-content' }, [
                        React.createElement('div', { className: 'search-controls', key: 'controls' }, [
                            React.createElement('input', {
                                key: 'search',
                                type: 'text',
                                placeholder: 'Search items...',
                                className: 'search-input',
                                value: searchTerm,
                                onChange: (e) => setSearchTerm(e.target.value)
                            }),
                            React.createElement('select', {
                                key: 'category',
                                className: 'filter-select',
                                value: categoryFilter,
                                onChange: (e) => setCategoryFilter(e.target.value)
                            }, [
                                React.createElement('option', { key: 'all', value: 'All' }, 'All Categories'),
                                ...categories.map(cat => 
                                    React.createElement('option', { key: cat, value: cat }, cat)
                                )
                            ]),
                            React.createElement('select', {
                                key: 'tier',
                                className: 'filter-select',
                                value: tierFilter,
                                onChange: (e) => setTierFilter(e.target.value)
                            }, [
                                React.createElement('option', { key: 'all', value: 'All' }, 'All Tiers'),
                                ...tiers.map(tier => 
                                    React.createElement('option', { key: tier, value: tier.toString() }, `Tier ${tier}`)
                                )
                            ])
                        ]),
                        React.createElement('div', { className: 'map-selector', key: 'map-selector' }, [
                            React.createElement('span', { className: 'map-label', key: 'label' }, 'Map:'),
                            ...Object.keys(MAP_RESOURCES).map(map =>
                                React.createElement('button', {
                                    key: map,
                                    className: `map-btn ${currentMap === map ? 'active' : ''}`,
                                    onClick: () => setCurrentMap(map)
                                }, map)
                            )
                        ]),
                        React.createElement('div', { 
                            key: 'stats',
                            style: {
                                marginBottom: '15px',
                                padding: '10px',
                                background: 'rgba(0, 212, 255, 0.1)',
                                borderRadius: '8px',
                                fontSize: '13px',
                                color: '#00d4ff',
                                textAlign: 'center'
                            }
                        }, `Showing: ${availableCount} available / ${totalCount} total items on ${currentMap}`),
                        React.createElement('div', { className: 'items-grid', key: 'items' },
                            itemsWithAvailability.length === 0 ? 
                                React.createElement('div', {
                                    style: {
                                        padding: '40px',
                                        textAlign: 'center',
                                        color: '#b0b3b8',
                                        gridColumn: '1 / -1'
                                    }
                                }, 'No items match your filters') :
                                itemsWithAvailability.map(({ item, recipe, isAvailable }) =>
                                    React.createElement(ItemCard, {
                                        key: item.name,
                                        item,
                                        recipe,
                                        isSelected: !!shoppingCart[item.name],
                                        isAvailable: isAvailable,
                                        onClick: addToCart,
                                        onQuantityChange: handleQuantityChange,
                                        currentQuantity: itemQuantities[item.name] || 0
                                    })
                                )
                        ),
                        renderResults()
                    ]);
                }

                if (activeTab === 'map') {
                    return React.createElement('div', { className: 'map-info', key: 'map-info' }, [
                        React.createElement('h3', { key: 'title' }, `🗺️ ${currentMap} Resources`),
                        React.createElement('p', { key: 'description' }, 
                            currentMap === 'Olympus' ? "The starter map with Forest, Arctic, and Desert biomes. ALL ORES available!" :
                            currentMap === 'Prometheus' ? "🌋 Volcanic DLC map with unique Obsidian deposits." :
                            currentMap === 'Styx' ? "💎 Advanced DLC map with all standard ores." : ""
                        ),
                        React.createElement('div', { className: 'resource-grid', key: 'resources' },
                            MAP_RESOURCES[currentMap]?.map(resource =>
                                React.createElement('div', {
                                    key: resource,
                                    className: 'resource-badge'
                                }, resource)
                            )
                        )
                    ]);
                }

                return null;
            };

            return React.createElement('div', { className: 'app-container' }, [
                React.createElement('div', { className: 'app-header', key: 'header' }, [
                    React.createElement('h1', { className: 'app-title', key: 'title' }, "🚀 ICARUS COMPLETE"),
                    React.createElement('p', { className: 'app-subtitle', key: 'subtitle' }, "Advanced Crafting Calculator • Fandom Wiki Data"),
                    React.createElement('div', { className: 'stats-header', key: 'stats' }, 
                        `📊 Database: ${allItems.length} Total Items from Icarus Fandom Wiki`
                    )
                ]),

                React.createElement('div', { className: 'main-content', key: 'main' }, [
                    React.createElement('div', { className: 'content-panel', key: 'content' }, [
                        React.createElement('div', { className: 'tab-nav', key: 'nav' }, [
                            React.createElement('button', {
                                key: 'calc-tab',
                                className: `tab-button ${activeTab === 'calculator' ? 'active' : ''}`,
                                onClick: () => setActiveTab('calculator')
                            }, "🔨 Calculator"),
                            React.createElement('button', {
                                key: 'map-tab',
                                className: `tab-button ${activeTab === 'map' ? 'active' : ''}`,
                                onClick: () => setActiveTab('map')
                            }, "🗺️ Map Info")
                        ]),
                        React.createElement('div', { className: 'tab-content', key: 'tab-content' }, 
                            renderTabContent()
                        )
                    ]),

                    React.createElement('div', { className: 'shopping-cart', key: 'cart' }, [
                        React.createElement('div', { className: 'cart-header', key: 'cart-header' }, [
                            React.createElement('h3', { className: 'cart-title', key: 'title' }, "🛒 Shopping Cart"),
                            React.createElement('span', { className: 'cart-count', key: 'count' }, Object.keys(shoppingCart).length)
                        ]),

                        React.createElement('div', { className: 'cart-items', key: 'cart-items' },
                            Object.keys(shoppingCart).length === 0 ? 
                                React.createElement('div', { className: 'cart-empty' }, "Add items to your cart to get started!") :
                                Object.entries(shoppingCart).map(([itemName, details]) =>
                                    React.createElement(CartItem, {
                                        key: itemName,
                                        item: details.item,
                                        details,
                                        onRemove: removeFromCart
                                    })
                                )
                        ),

                        React.createElement('div', { className: 'action-buttons', key: 'actions' }, [
                            React.createElement('button', {
                                key: 'calculate',
                                className: 'btn primary',
                                onClick: calculateRequirements,
                                disabled: Object.keys(shoppingCart).length === 0
                            }, "🧮 Calculate"),
                            React.createElement('button', {
                                key: 'clear',
                                className: 'btn secondary',
                                onClick: clearCart,
                                disabled: Object.keys(shoppingCart).length === 0
                            }, "🗑️ Clear")
                        ]),

                        React.createElement('div', { 
                            className: 'stats-panel',
                            key: 'stats'
                        }, [
                            React.createElement('div', { key: 'total' }, `Total Database: ${allItems.length} items`),
                            React.createElement('div', { key: 'cart' }, `Cart Items: ${Object.keys(shoppingCart).length}`)
                        ])
                    ])
                ])
            ]);
        }

        ReactDOM.render(React.createElement(CraftingCalculator), document.getElementById('root'));
    </script>
</body>
</html>
